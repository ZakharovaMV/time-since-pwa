<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="–°–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <title>–°–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ —Å –¥–∞—Ç—ã</title>

  <style>
    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f6f7; color: #111; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 18px; }
    .card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    label { font-size: 13px; color: #555; }
    input { width: 100%; font-size: 16px; padding: 12px; border-radius: 12px; border: 1px solid #ddd; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .item { background: #fafafa; border: 1px solid #eee; border-radius: 12px; padding: 12px; }
    .k { font-size: 12px; color: #666; margin-bottom: 6px; }
    .v { font-size: 20px; font-weight: 650; }
    .hint { font-size: 12px; color: #666; margin-top: 10px; line-height: 1.35; }
    .warn { margin-top: 12px; color: #a00000; font-size: 13px; display: none; }
    button { margin-top: 12px; width: 100%; border: 0; border-radius: 12px; padding: 12px; font-size: 16px; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>–°–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ —Å –¥–∞—Ç—ã</h1>

      <div class="row">
        <div>
          <label for="dt">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</label>
          <input id="dt" type="datetime-local" />
        </div>
      </div>

      <div class="row2">
        <button type="button" id="nowBtn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –¥–∞—Ç—É: —Å–µ–π—á–∞—Å</button>
        <button type="button" id="clearBtn">–°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</button>
      </div>

      <div class="grid" id="results">
        <div class="item"><div class="k">–ì–æ–¥—ã</div><div class="v" id="years">‚Äî</div></div>
        <div class="item"><div class="k">–ú–µ—Å—è—Ü—ã</div><div class="v" id="months">‚Äî</div></div>
        <div class="item"><div class="k">–î–Ω–∏</div><div class="v" id="days">‚Äî</div></div>
        <div class="item"><div class="k">–í—Å–µ–≥–æ –¥–Ω–µ–π</div><div class="v" id="totalDays">‚Äî</div></div>
        <div class="item"><div class="k">–í—Å–µ–≥–æ —á–∞—Å–æ–≤</div><div class="v" id="totalHours">‚Äî</div></div>
        <div class="item"><div class="k">–í—Å–µ–≥–æ –º–∏–Ω—É—Ç</div><div class="v" id="totalMinutes">‚Äî</div></div>
      </div>

      <div class="warn" id="futureWarn">
        –í—ã –≤—ã–±—Ä–∞–ª–∏ –¥–∞—Ç—É –≤ –±—É–¥—É—â–µ–º ‚Äî ‚Äú—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ‚Äù –±—É–¥–µ—Ç 0.
      </div>

      <div class="hint">
        ‚Äú–ì–æ–¥—ã/–º–µ—Å—è—Ü—ã/–¥–Ω–∏‚Äù —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é, –∞ ‚Äú–≤—Å–µ–≥–æ –¥–Ω–µ–π/—á–∞—Å–æ–≤/–º–∏–Ω—É—Ç‚Äù ‚Äî –ø–æ —Ç–æ—á–Ω–æ–π —Ä–∞–∑–Ω–∏—Ü–µ.
        –î–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
      </div>
    </div>
  </div>

  <script>
    // PWA offline
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }

    const STORAGE_KEY = "time_since_selected_dt";

    const dt = document.getElementById('dt');
    const futureWarn = document.getElementById('futureWarn');

    const out = {
      years: document.getElementById('years'),
      months: document.getElementById('months'),
      days: document.getElementById('days'),
      totalDays: document.getElementById('totalDays'),
      totalHours: document.getElementById('totalHours'),
      totalMinutes: document.getElementById('totalMinutes'),
    };

    function pad(n){ return String(n).padStart(2,'0'); }

    function formatForDatetimeLocal(d) {
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function yesterdayLocalValue() {
      const d = new Date();
      d.setDate(d.getDate() - 1);
      return formatForDatetimeLocal(d);
    }

    function nowLocalValue() {
      return formatForDatetimeLocal(new Date());
    }

    // –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞: –≥–æ–¥—ã/–º–µ—Å—è—Ü—ã/–¥–Ω–∏
    function calendarDiff(start, end) {
      let y = end.getFullYear() - start.getFullYear();
      let m = end.getMonth() - start.getMonth();
      let d = end.getDate() - start.getDate();

      if (d < 0) {
        const prevMonth = new Date(end.getFullYear(), end.getMonth(), 0);
        d += prevMonth.getDate();
        m -= 1;
      }
      if (m < 0) {
        m += 12;
        y -= 1;
      }
      if (y < 0) y = m = d = 0;

      return { years: y, months: m, days: d };
    }

    function update() {
      if (!dt.value) return;

      const start = new Date(dt.value);
      const end = new Date();

      if (isNaN(start.getTime())) return;

      if (start > end) {
        futureWarn.style.display = 'block';
        out.years.textContent = '0';
        out.months.textContent = '0';
        out.days.textContent = '0';
        out.totalDays.textContent = '0';
        out.totalHours.textContent = '0';
        out.totalMinutes.textContent = '0';
        return;
      } else {
        futureWarn.style.display = 'none';
      }

      const cal = calendarDiff(start, end);

      const ms = end - start;
      const totalMinutes = Math.floor(ms / 60000);
      const totalHours = Math.floor(ms / 3600000);
      const totalDays = Math.floor(ms / 86400000);

      out.years.textContent = cal.years;
      out.months.textContent = cal.months;
      out.days.textContent = cal.days;

      out.totalDays.textContent = totalDays;
      out.totalHours.textContent = totalHours;
      out.totalMinutes.textContent = totalMinutes;
    }

    // ‚úÖ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    dt.addEventListener('input', () => {
      localStorage.setItem(STORAGE_KEY, dt.value);
      update();
    });

    document.getElementById('nowBtn').addEventListener('click', () => {
      dt.value = nowLocalValue();
      localStorage.setItem(STORAGE_KEY, dt.value);
      update();
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY);
      dt.value = yesterdayLocalValue();
      localStorage.setItem(STORAGE_KEY, dt.value);
      update();
      alert("–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è –¥–∞—Ç–∞ —Å–±—Ä–æ—à–µ–Ω–∞.");
    });

    // ‚úÖ —Å—Ç–∞—Ä—Ç: –±–µ—Ä—ë–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –¥–∞—Ç—É, –∏–Ω–∞—á–µ —Å—Ç–∞–≤–∏–º ‚Äú–≤—á–µ—Ä–∞‚Äù
    (function init(){
      const saved = localStorage.getItem(STORAGE_KEY);
      dt.value = (saved && saved.length) ? saved : yesterdayLocalValue();

      // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ ‚Äî —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω–∏–º
      if (!saved) localStorage.setItem(STORAGE_KEY, dt.value);

      update();

      // üîÅ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è ‚Äî –Ω–µ –º–µ–Ω—è–µ–º dt.value
      setInterval(update, 1000);
    })();
  </script>
</body>
</html>
